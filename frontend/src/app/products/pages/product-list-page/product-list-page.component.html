<div class="products-page">
  <!-- Barra de Busca Sticky -->
  <div class="search-bar-sticky">
    <div class="container">
      <div class="search-wrapper">
        <mat-icon class="search-icon">search</mat-icon>
        <input 
          type="text" 
          [(ngModel)]="searchTerm"
          (input)="onSearchInput($event)"
          placeholder="Buscar produtos..." 
          class="search-input">
        <button *ngIf="searchTerm" (click)="searchTerm = ''; filterAndGroupProducts()" class="clear-search" mat-icon-button>
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
      <div class="loading-spinner"></div>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="error-container">
      <p class="error-message">{{ error }}</p>
      <button (click)="loadProducts()" class="retry-button">
        Tentar Novamente
      </button>
    </div>

    <!-- Lista de Produtos Agrupada por Categoria -->
    <div *ngIf="!loading && !error" class="menu-list">
      <!-- Seção de Combos -->
      <div *ngIf="combos.length > 0 && (!searchTerm || searchTerm.trim() === '')" class="category-group">
        <h2 class="category-separator">Combos</h2>
        
        <div class="menu-items">
          <div *ngFor="let combo of combos" class="menu-item">
            <!-- Imagem -->
            <div class="menu-item-image">
              <img [src]="getImageUrl(comboAdapter(combo))" [alt]="combo.name">
            </div>

            <!-- Informações -->
            <div class="menu-item-info">
              <h3 class="menu-item-name">{{ combo.name }}</h3>
              <p class="menu-item-description" *ngIf="combo.description">
                {{ combo.description }}
              </p>
            </div>

            <!-- Ação (Preço e Botão) -->
            <div class="menu-item-action">
              <div class="item-actions">
                <span class="price">R$ {{ combo.price | number:'1.2-2' }}</span>
                
                <!-- Botão Adicionar (quando quantidade = 0) -->
                <button 
                  *ngIf="getQuantity(comboAdapter(combo)) === 0" 
                  (click)="addComboToCart(combo)" 
                  class="btn-add">
                  Adicionar
                </button>
                
                <!-- Controles de Quantidade (quando quantidade > 0) -->
                <div *ngIf="getQuantity(comboAdapter(combo)) > 0" class="qty-controls">
                  <button 
                    (click)="decrease(comboAdapter(combo))" 
                    class="qty-btn minus">
                    -
                  </button>
                  <span class="qty-value">{{ getQuantity(comboAdapter(combo)) }}</span>
                  <button 
                    (click)="addComboToCart(combo)" 
                    class="qty-btn plus">
                    +
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Outras Categorias -->
      <div *ngFor="let group of productsByCategory" class="category-group">
        <h2 class="category-separator">{{ group.category.name }}</h2>
        
        <div class="menu-items">
          <div *ngFor="let product of group.products" class="menu-item">
            <!-- Imagem -->
            <div class="menu-item-image">
              <img [src]="getImageUrl(product)" [alt]="product.name">
            </div>

            <!-- Informações -->
            <div class="menu-item-info">
              <h3 class="menu-item-name">{{ product.name }}</h3>
              <p class="menu-item-description" *ngIf="product.description">
                {{ product.description }}
              </p>
            </div>

            <!-- Ação (Preço e Botão) -->
            <div class="menu-item-action">
              <div class="item-actions">
                <span class="price">R$ {{ product.price | number:'1.2-2' }}</span>
                
                <!-- Botão Adicionar (quando quantidade = 0) -->
                <button 
                  *ngIf="getQuantity(product) === 0" 
                  (click)="increase(product)" 
                  class="btn-add" 
                  [disabled]="product.current_stock <= 0">
                  {{ product.current_stock > 0 ? 'Adicionar' : 'Esgotado' }}
                </button>
                
                <!-- Controles de Quantidade (quando quantidade > 0) -->
                <div *ngIf="getQuantity(product) > 0" class="qty-controls">
                  <button 
                    (click)="decrease(product)" 
                    class="qty-btn minus">
                    -
                  </button>
                  <span class="qty-value">{{ getQuantity(product) }}</span>
                  <button 
                    (click)="increase(product)" 
                    class="qty-btn plus"
                    [disabled]="getQuantity(product) >= product.current_stock">
                    +
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Estado Vazio -->
    <div *ngIf="!loading && !error && productsByCategory.length === 0" class="empty-state">
      <mat-icon class="empty-icon">restaurant_menu</mat-icon>
      <h2>Nenhum produto encontrado</h2>
      <p>Tente ajustar os filtros ou realizar uma nova busca</p>
    </div>
  </div>
</div>
