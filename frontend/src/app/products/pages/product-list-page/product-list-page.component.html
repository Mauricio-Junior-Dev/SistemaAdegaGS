<div class="products-page">
  <!-- Barra de Busca Sticky - Estilo minimalista (iFood/Zé) -->
  <div class="search-bar-sticky">
    <div class="container">
      <div class="search-wrapper modern-search-bar">
        <mat-icon class="search-icon" aria-hidden="true">search</mat-icon>
        <input
          type="search"
          name="search"
          [(ngModel)]="searchTerm"
          (input)="onSearchInput($event)"
          placeholder="Buscar produtos..."
          class="search-input"
          autocomplete="off">
        <button *ngIf="searchTerm" (click)="searchTerm = ''; applyMenuFilters()" class="clear-search" mat-icon-button type="button" aria-label="Limpar busca">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
      <div class="loading-spinner"></div>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="error-container">
      <p class="error-message">{{ error }}</p>
      <button (click)="loadMenu()" class="retry-button">
        Tentar Novamente
      </button>
    </div>

    <!-- Lista de Produtos Agrupada por Categoria -->
    <div *ngIf="!loading && !error" class="menu-list">
      <!-- Botão Voltar (quando está vendo uma categoria específica) -->
      <div *ngIf="selectedCategory" class="back-to-menu-wrapper">
        <button type="button" (click)="backToFullMenu()" class="btn-back-menu">
          <mat-icon class="btn-back-icon">arrow_back</mat-icon>
          Voltar para todo o cardápio
        </button>
      </div>

      <!-- Seção de Combos (Montar = ir para detalhes; não adicionar direto ao carrinho)
           Exibida apenas quando não há categoria específica selecionada -->
      <div *ngIf="!selectedCategory && filteredCombos.length > 0" class="category-group combo-section">
        <h2 class="category-separator">Combos</h2>
        
        <div class="menu-items">
          <div *ngFor="let combo of filteredCombos" class="menu-item">
            <!-- Imagem (clicável para detalhes) -->
            <div class="menu-item-image" (click)="goToComboDetails(combo)" role="button" tabindex="0">
              <img [src]="getImageUrl(comboAdapter(combo))" [alt]="combo.name">
            </div>

            <!-- Informações -->
            <div class="menu-item-info" (click)="goToComboDetails(combo)" role="button" tabindex="0">
              <h3 class="menu-item-name">{{ combo.name }}</h3>
              <p class="menu-item-description" *ngIf="combo.description">
                {{ combo.description }}
              </p>
            </div>

            <!-- Ação: preço + botão Montar (igual à Home) -->
            <div class="menu-item-action">
              <div class="item-actions item-actions-combo">
                <span class="price price-from-label">A partir de </span>
                <span class="price price-value">R$ {{ getComboPrice(combo) | number:'1.2-2' }}</span>
                <button 
                  (click)="goToComboDetails(combo)" 
                  class="btn-add btn-montar"
                  type="button">
                  <mat-icon class="btn-montar-icon">tune</mat-icon>
                  Montar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Outras Categorias (prateleiras limitadas: 8 itens iniciais + "Ver todos") -->
      <div *ngFor="let group of productsByCategory" class="category-group">
        <h2 class="category-separator category-separator-clickable" 
            (click)="focusCategory(group.category.id)" 
            (keydown.enter)="focusCategory(group.category.id)"
            tabindex="0"
            role="button">
          {{ group.category.name }}
        </h2>
        
        <div class="menu-items">
          <div *ngFor="let product of group.products | slice:0:(isCategoryFocused(group.category) ? group.products.length : limitPerCategory)" class="menu-item">
            <!-- Imagem -->
            <div class="menu-item-image">
              <img [src]="getImageUrl(product)" [alt]="product.name">
            </div>

            <!-- Informações -->
            <div class="menu-item-info">
              <h3 class="menu-item-name">{{ product.name }}</h3>
              <p class="menu-item-description" *ngIf="product.description">
                {{ product.description }}
              </p>
            </div>

            <!-- Ação (Preço e Botão) -->
            <div class="menu-item-action">
              <div class="item-actions">
                <span class="price">R$ {{ (product.delivery_price ?? product.price) | number:'1.2-2' }}</span>
                
                <!-- Botão Adicionar (quando quantidade = 0) -->
                <button 
                  *ngIf="getQuantity(product) === 0" 
                  (click)="increase(product)" 
                  class="btn-add" 
                  [disabled]="product.current_stock <= 0">
                  {{ product.current_stock > 0 ? 'Adicionar' : 'Esgotado' }}
                </button>
                
                <!-- Controles de Quantidade (quando quantidade > 0) -->
                <div *ngIf="getQuantity(product) > 0" class="qty-controls">
                  <button 
                    (click)="decrease(product)" 
                    class="qty-btn minus">
                    -
                  </button>
                  <span class="qty-value">{{ getQuantity(product) }}</span>
                  <button 
                    (click)="increase(product)" 
                    class="qty-btn plus"
                    [disabled]="getQuantity(product) >= product.current_stock">
                    +
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Ver todos: foca na categoria (filtro) -->
        <div *ngIf="!isCategoryFocused(group.category) && group.products.length > limitPerCategory" class="ver-todos-wrapper">
          <button type="button" (click)="focusCategory(group.category.id)" class="btn-ver-todos">
            Ver todos os {{ group.products.length }} produtos de {{ group.category.name }}
          </button>
        </div>
      </div>
    </div>

    <!-- Estado Vazio -->
    <div *ngIf="!loading && !error && productsByCategory.length === 0" class="empty-state">
      <mat-icon class="empty-icon">restaurant_menu</mat-icon>
      <h2>Nenhum produto encontrado</h2>
      <p>Tente ajustar os filtros ou realizar uma nova busca</p>
    </div>
  </div>
</div>
