<div class="combo-detail-page">
  <div class="container">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Carregando combo...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="error-message">
      <mat-icon>error_outline</mat-icon>
      <span>{{ error }}</span>
    </div>

    <!-- Combo Detail -->
    <div *ngIf="!loading && !error && bundle" class="combo-detail">
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a routerLink="/">Home</a>
        <span>></span>
        <a routerLink="/combos">Combos</a>
        <span>></span>
        <span>{{ bundle.name }}</span>
      </nav>

      <!-- Header do Produto -->
      <div class="combo-header">
        <div class="combo-image-section">
          <div *ngIf="getDiscountPercentage(bundle) > 0" class="discount-badge">
            -{{ getDiscountPercentage(bundle) }}%
          </div>
          <img [src]="getBundleImage(bundle)" [alt]="bundle.name" class="combo-image">
        </div>

        <div class="combo-info-section">
          <h1 class="combo-title">{{ bundle.name }}</h1>
          
          <div class="combo-price-section">
            <div *ngIf="bundle.original_price && bundle.original_price > (bundle.base_price || 0)" class="original-price">
              {{ formatPrice(bundle.original_price) }}
            </div>
            <div class="current-price">
              {{ formatPrice(displayedPrice) }}
            </div>
            <div *ngIf="bundle.original_price && bundle.original_price > (bundle.base_price || 0)" class="savings-badge">
              <mat-icon>savings</mat-icon>
              <span>Economize {{ formatPrice(bundle.original_price - (bundle.base_price || 0)) }}</span>
            </div>
          </div>

          <p *ngIf="bundle.description" class="combo-description">
            {{ bundle.description }}
          </p>
        </div>
      </div>

      <!-- Grupos de Opção (Accordion) -->
      <div *ngIf="bundle.groups && bundle.groups.length > 0" class="groups-section">
        <mat-accordion class="groups-accordion">
          <mat-expansion-panel 
            *ngFor="let group of bundle.groups; trackBy: trackByGroupId"
            [expanded]="isPanelExpanded(group)"
            class="group-panel"
            [class.required]="group.is_required"
            [class.invalid]="!isGroupValid(group)">
            
            <!-- Header do Painel -->
            <mat-expansion-panel-header class="panel-header">
              <mat-panel-title class="panel-title">
                <div class="title-content">
                  <span class="group-name">{{ group.name }}</span>
                  <mat-chip *ngIf="group.is_required" class="required-chip">Obrigatório</mat-chip>
                  <mat-chip *ngIf="!group.is_required" class="optional-chip">Opcional</mat-chip>
                </div>
              </mat-panel-title>
              <mat-panel-description class="panel-description">
                <span class="instruction-text">{{ getGroupInstruction(group) }}</span>
                <span *ngIf="getGroupValidationMessage(group)" class="validation-error">
                  {{ getGroupValidationMessage(group) }}
                </span>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <!-- Conteúdo do Painel -->
            <div class="panel-content">
              <p *ngIf="group.description" class="group-description">{{ group.description }}</p>
              
              <!-- Lista de Opções -->
              <div class="options-list">
                <div 
                  *ngFor="let option of group.options; trackBy: trackByOptionId" 
                  class="option-item"
                  [class.selected]="isOptionSelected(group, option)"
                  (click)="onOptionItemClick(group, option, $event)">
                  <!-- Miniatura -->
                  <div class="option-thumbnail">
                    <img 
                      [src]="getProductImage(option.product)" 
                      [alt]="option.product?.name || 'Produto'"
                      class="thumbnail-image"
                      onerror="this.src='assets/images/no-image.jpg'">
                  </div>

                  <!-- Texto -->
                  <div class="option-info">
                    <div class="option-name">{{ option.product?.name || 'Produto' }}</div>
                    <div class="option-meta">
                      <span *ngIf="group.max_selections > 1" class="max-selections">
                        Máx {{ group.max_selections }}
                      </span>
                      <span *ngIf="option.price_adjustment > 0" class="price-adjustment">
                        + {{ formatPrice(option.price_adjustment) }}
                      </span>
                    </div>
                  </div>

                  <!-- Controle (Direita) -->
                  <div class="option-control" (click)="$event.stopPropagation()">
                    <!-- Radio Button (max_selections == 1) -->
                    <mat-radio-button
                      *ngIf="group.max_selections === 1"
                      [value]="option"
                      [checked]="getSelectedOption(group)?.id === option.id"
                      (change)="onRadioSelect(group, option)"
                      class="option-radio">
                    </mat-radio-button>

                    <!-- Checkbox ou Contador (max_selections > 1) -->
                    <div *ngIf="group.max_selections > 1" class="quantity-control">
                      <button 
                        mat-icon-button
                        type="button"
                        (click)="onQuantityChange(group, option, -1); $event.stopPropagation()"
                        [disabled]="getOptionQuantity(group, option) === 0"
                        class="quantity-btn">
                        <mat-icon>remove</mat-icon>
                      </button>
                      <span class="quantity-display">{{ getOptionQuantity(group, option) }}</span>
                      <button 
                        mat-icon-button
                        type="button"
                        (click)="onQuantityChange(group, option, 1); $event.stopPropagation()"
                        [disabled]="!canSelectMore(group)"
                        class="quantity-btn">
                        <mat-icon>add</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </div>

      <!-- Campo de Observações -->
      <div class="observations-section">
        <mat-form-field appearance="outline" class="observations-field">
          <mat-label>Observações (opcional)</mat-label>
          <textarea 
            matInput 
            [(ngModel)]="observations"
            placeholder="Ex: Sem gelo, sem açúcar, etc."
            rows="3"
            maxlength="500"></textarea>
          <mat-hint>{{ observations.length }}/500</mat-hint>
        </mat-form-field>
      </div>
    </div>
  </div>

  <!-- Barra Fixa (Rodapé) -->
  <div class="fixed-footer" *ngIf="!loading && !error && bundle">
    <div class="footer-content">
      <div class="quantity-control-footer">
        <button 
          mat-icon-button
          (click)="decrementQuantity()" 
          [disabled]="quantity <= 1"
          class="footer-btn">
          <mat-icon>remove</mat-icon>
        </button>
        <span class="quantity-value">{{ quantity }}</span>
        <button 
          mat-icon-button
          (click)="incrementQuantity()"
          class="footer-btn">
          <mat-icon>add</mat-icon>
        </button>
      </div>

      <div class="price-section">
        <div class="price-label">Total</div>
        <div class="price-value">{{ formatPrice(getTotalPrice()) }}</div>
      </div>

      <button 
        mat-raised-button
        color="primary"
        (click)="onAddToCart()" 
        [disabled]="!canAddToCart()"
        class="add-button">
        <mat-icon>add_shopping_cart</mat-icon>
        <span>Adicionar</span>
      </button>
    </div>
  </div>
</div>
