<div class="checkout-page">
  <!-- Header com Progresso -->
  <div class="checkout-header">
    <div class="container">
      <div class="header-content">
        <div class="logo-section">
          <h1>Finalizar Pedido</h1>
          <p class="subtitle">Complete sua compra de forma rápida e segura</p>
        </div>
        
        <!-- Barra de Progresso -->
        <div class="progress-container">
          <div class="progress-steps">
            <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
              <div class="step-number">1</div>
              <span class="step-label">Carrinho</span>
            </div>
            <div class="step-line" [class.completed]="currentStep > 1"></div>
            
            <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
              <div class="step-number">2</div>
              <span class="step-label">Entrega</span>
            </div>
            <div class="step-line" [class.completed]="currentStep > 2"></div>
            
            <div class="step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3">
              <div class="step-number">3</div>
              <span class="step-label">Pagamento</span>
            </div>
            <div class="step-line" [class.completed]="currentStep > 3"></div>
            
            <div class="step" [class.active]="currentStep >= 4">
              <div class="step-number">4</div>
              <span class="step-label">Confirmação</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="checkout-container">
    <div class="checkout-layout">
      <!-- Conteúdo Principal -->
      <div class="checkout-main">
        <div class="checkout-steps">
          
          <!-- Step 1: Resumo do Carrinho -->
          <div class="step-card" [class.active]="currentStep === 1">
            <div class="step-header">
              <div class="step-icon">
                <mat-icon>shopping_cart</mat-icon>
              </div>
              <div class="step-info">
                <h2>Confirme seus itens</h2>
                <p>Verifique os produtos que você está comprando</p>
              </div>
            </div>
            
            <div class="step-content" *ngIf="currentStep === 1">
              <div class="cart-items-list">
                <div *ngFor="let item of cartItems$ | async" class="cart-item-modern">
                  <div class="item-image">
                    <img [src]="getImageUrl(item.product)" [alt]="item.product.name">
                    <div class="quantity-badge">{{ item.quantity }}</div>
                  </div>
                  <div class="item-details">
                    <h4 class="item-name">{{ item.product.name }}</h4>
                    <p class="item-category">{{ item.product.category?.name || 'Categoria' }}</p>
                    <div class="item-price">
                      <span class="unit-price">R$ {{ item.price | number:'1.2-2' }} cada</span>
                      <span class="total-price">R$ {{ (item.price * item.quantity) | number:'1.2-2' }}</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="step-actions">
                <button mat-raised-button color="primary" (click)="nextStep()" class="continue-btn">
                  <mat-icon>arrow_forward</mat-icon>
                  Continuar para Entrega
                </button>
              </div>
            </div>
          </div>

          <!-- Step 2: Endereço de Entrega -->
          <div class="step-card" [class.active]="currentStep === 2">
            <div class="step-header">
              <div class="step-icon">
                <mat-icon>location_on</mat-icon>
              </div>
              <div class="step-info">
                <h2>Onde entregar?</h2>
                <p>Escolha ou cadastre um endereço de entrega</p>
              </div>
            </div>
            
            <div class="step-content" *ngIf="currentStep === 2">
              <form [formGroup]="deliveryForm" class="delivery-form">
                <!-- Seleção de Endereços Salvos -->
                <div *ngIf="addresses.length > 0" class="address-selection">
                  <div class="address-options">
                    <mat-radio-group [value]="useSavedAddress" (change)="onAddressOptionChange($event)">
                      <mat-radio-button [value]="true" *ngIf="addresses.length > 0" class="address-option">
                        <div class="option-content">
                          <mat-icon>bookmark</mat-icon>
                          <span>Usar endereço salvo</span>
                        </div>
                      </mat-radio-button>
                      <mat-radio-button [value]="false" class="address-option">
                        <div class="option-content">
                          <mat-icon>add_location</mat-icon>
                          <span>Novo endereço</span>
                        </div>
                      </mat-radio-button>
                    </mat-radio-group>
                  </div>

                  <!-- Lista de Endereços Salvos -->
                  <div *ngIf="useSavedAddress" class="saved-addresses">
                    <div *ngFor="let address of addresses" 
                         class="address-card" 
                         [class.selected]="selectedAddressId === address.id"
                         (click)="selectAddress(address.id)">
                      <div class="address-header">
                        <h4>{{address.name || 'Endereço'}}</h4>
                        <mat-chip *ngIf="address.is_default" color="primary" class="default-chip">
                          <mat-icon>star</mat-icon>
                          Padrão
                        </mat-chip>
                      </div>
                      <div class="address-details">
                        <p><strong>{{address.street}}, {{address.number}}</strong></p>
                        <p *ngIf="address.complement">{{address.complement}}</p>
                        <p>{{address.neighborhood}}, {{address.city}}/{{address.state}}</p>
                        <p>CEP: {{address.zipcode}}</p>
                        <p *ngIf="address.notes"><em>{{address.notes}}</em></p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Formulário de Endereço -->
                <div class="address-form" *ngIf="!useSavedAddress">
                  <div class="form-section">
                    <h4>Informações do Endereço</h4>
                    
                    <div class="cep-field">
                      <mat-form-field class="cep-input">
                        <mat-label>CEP</mat-label>
                        <input matInput formControlName="zipcode" placeholder="00000-000" (input)="formatZipcode($event); clearError()">
                        <mat-error *ngIf="deliveryForm.get('zipcode')?.errors?.['required']">CEP é obrigatório</mat-error>
                        <mat-error *ngIf="deliveryForm.get('zipcode')?.errors?.['pattern']">CEP inválido</mat-error>
                      </mat-form-field>
                      <button mat-raised-button color="primary" (click)="searchCep()" 
                              [disabled]="!deliveryForm.get('zipcode')?.value || deliveryForm.get('zipcode')?.errors || loading"
                              class="cep-button">
                        <mat-icon>search</mat-icon>
                        <span *ngIf="!loading">Buscar</span>
                        <span *ngIf="loading">Buscando...</span>
                      </button>
                    </div>

                    <div class="form-grid">
                      <mat-form-field>
                        <mat-label>Endereço</mat-label>
                        <input matInput formControlName="address" placeholder="Rua, Avenida, etc">
                        <mat-error *ngIf="deliveryForm.get('address')?.errors?.['required']">Endereço é obrigatório</mat-error>
                      </mat-form-field>

                      <mat-form-field>
                        <mat-label>Número</mat-label>
                        <input matInput formControlName="number" placeholder="123">
                        <mat-error *ngIf="deliveryForm.get('number')?.errors?.['required']">Número é obrigatório</mat-error>
                      </mat-form-field>

                      <mat-form-field>
                        <mat-label>Complemento</mat-label>
                        <input matInput formControlName="complement" placeholder="Apto, Bloco, etc">
                      </mat-form-field>

                      <mat-form-field>
                        <mat-label>Bairro</mat-label>
                        <input matInput formControlName="neighborhood" placeholder="Seu bairro">
                        <mat-error *ngIf="deliveryForm.get('neighborhood')?.errors?.['required']">Bairro é obrigatório</mat-error>
                      </mat-form-field>

                      <mat-form-field>
                        <mat-label>Cidade</mat-label>
                        <input matInput formControlName="city" placeholder="Sua cidade">
                        <mat-error *ngIf="deliveryForm.get('city')?.errors?.['required']">Cidade é obrigatória</mat-error>
                      </mat-form-field>

                      <mat-form-field>
                        <mat-label>Estado</mat-label>
                        <input matInput formControlName="state" placeholder="UF">
                        <mat-error *ngIf="deliveryForm.get('state')?.errors?.['required']">Estado é obrigatório</mat-error>
                      </mat-form-field>

                      <mat-form-field>
                        <mat-label>Telefone</mat-label>
                        <input matInput formControlName="phone" placeholder="(00) 00000-0000" (input)="formatPhone($event)">
                        <mat-error *ngIf="deliveryForm.get('phone')?.errors?.['required']">Telefone é obrigatório</mat-error>
                        <mat-error *ngIf="deliveryForm.get('phone')?.errors?.['pattern']">Telefone inválido</mat-error>
                      </mat-form-field>

                      <mat-form-field class="full-width">
                        <mat-label>Instruções para entrega</mat-label>
                        <textarea matInput formControlName="instructions" placeholder="Instruções especiais para entrega"></textarea>
                      </mat-form-field>
                    </div>
                  </div>
                </div>

                <div class="step-actions">
                  <button mat-button (click)="prevStep()" class="back-btn">
                    <mat-icon>arrow_back</mat-icon>
                    Voltar
                  </button>
                  <button mat-raised-button color="primary" (click)="nextStep()" [disabled]="!isDeliveryFormValid()" class="continue-btn">
                    <mat-icon>arrow_forward</mat-icon>
                    Continuar para Pagamento
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Step 3: Forma de Pagamento -->
          <div class="step-card" [class.active]="currentStep === 3">
            <div class="step-header">
              <div class="step-icon">
                <mat-icon>payment</mat-icon>
              </div>
              <div class="step-info">
                <h2>Como pagar?</h2>
                <p>Escolha a forma de pagamento que preferir</p>
              </div>
            </div>
            
            <div class="step-content" *ngIf="currentStep === 3">
              <form [formGroup]="paymentForm">
                <div class="payment-methods">
                  <mat-radio-group formControlName="method">
                    <mat-radio-button value="pix" class="payment-option">
                      <div class="payment-card">
                        <div class="payment-icon">
                          <mat-icon>qr_code</mat-icon>
                        </div>
                        <div class="payment-info">
                          <h4>PIX</h4>
                          <p>Pagamento instantâneo</p>
                        </div>
                        <div class="payment-badge">
                          <span>Recomendado</span>
                        </div>
                      </div>
                    </mat-radio-button>

                    <mat-radio-button value="cash" class="payment-option">
                      <div class="payment-card">
                        <div class="payment-icon">
                          <mat-icon>money</mat-icon>
                        </div>
                        <div class="payment-info">
                          <h4>Dinheiro</h4>
                          <p>Pagamento na entrega</p>
                        </div>
                      </div>
                    </mat-radio-button>

                    <mat-radio-button value="card" class="payment-option">
                      <div class="payment-card">
                        <div class="payment-icon">
                          <mat-icon>credit_card</mat-icon>
                        </div>
                        <div class="payment-info">
                          <h4>Cartão</h4>
                          <p>Cartão na entrega</p>
                        </div>
                      </div>
                    </mat-radio-button>
                  </mat-radio-group>

                  <div *ngIf="paymentForm.get('method')?.value === 'cash'" class="change-field">
                    <mat-form-field>
                      <mat-label>Troco para</mat-label>
                      <input matInput formControlName="change" type="number" placeholder="0.00">
                      <mat-hint>Deixe em branco se não precisar de troco</mat-hint>
                    </mat-form-field>
                  </div>
                </div>

                <!-- Mensagem de Erro -->
                <div *ngIf="error" class="error-message">
                  <mat-icon>error</mat-icon>
                  <span>{{ error }}</span>
                </div>

                <div class="step-actions">
                  <button mat-button (click)="prevStep()" [disabled]="loading" class="back-btn">
                    <mat-icon>arrow_back</mat-icon>
                    Voltar
                  </button>
                  <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="paymentForm.invalid || loading" class="finalize-btn">
                    <mat-spinner *ngIf="loading" diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
                    <mat-icon *ngIf="!loading">check</mat-icon>
                    <span *ngIf="!loading">Finalizar Pedido</span>
                    <span *ngIf="loading">Processando...</span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar com Resumo -->
      <div class="checkout-sidebar">
        <div class="order-summary-card">
          <div class="summary-header">
            <h3>Resumo do Pedido</h3>
            <div class="item-count">{{ (cartItems$ | async)?.length || 0 }} itens</div>
          </div>
          
          <div class="cart-items">
            <div *ngFor="let item of cartItems$ | async" class="cart-item">
              <div class="item-image">
                <img [src]="getImageUrl(item.product)" [alt]="item.product.name">
              </div>
              <div class="item-details">
                <h4 class="item-name">{{ item.product.name }}</h4>
                <div class="item-info">
                  <span class="item-quantity">Qtd: {{ item.quantity }}</span>
                  <span class="item-price">R$ {{ item.price | number:'1.2-2' }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="order-totals">
            <div class="total-row">
              <span>Subtotal</span>
              <span>R$ {{ cartTotal$ | async | number:'1.2-2' }}</span>
            </div>
            <div class="total-row">
              <span>Taxa de entrega</span>
              <span class="free-delivery">Grátis</span>
            </div>
            <div class="total-final">
              <span>Total</span>
              <span>R$ {{ cartTotal$ | async | number:'1.2-2' }}</span>
            </div>
          </div>

          <!-- Garantias e Segurança -->
          <div class="security-badges">
            <div class="badge">
              <mat-icon>security</mat-icon>
              <span>Compra 100% Segura</span>
            </div>
            <div class="badge">
              <mat-icon>local_shipping</mat-icon>
              <span>Entrega Rápida</span>
            </div>
            <div class="badge">
              <mat-icon>support_agent</mat-icon>
              <span>Suporte 24/7</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>