<div class="checkout-page">
  <!-- Página de Pagamento PIX -->
  <div *ngIf="checkoutState === 'awaiting_payment'" class="pix-payment-container">
    <div class="pix-container">
      <h2>Pague com PIX para Concluir</h2>
      <p class="subtitle-text">Seu pedido só será confirmado após o pagamento.</p>

      <p class="instruction-text">Escaneie o QR Code abaixo com o app do seu banco:</p>

      <img *ngIf="safeQrCodeUrl" [src]="safeQrCodeUrl" alt="QR Code PIX" class="qr-code-image">

      <div class="copia-cola-container">
        <span class="small-label">Ou use o Copia e Cola:</span>
        <div class="input-group-compact">
          <input type="text" [value]="pixCopiaECola || ''" readonly class="pix-input-compact">
          <button mat-raised-button color="primary" (click)="copiarPix()" [disabled]="!pixCopiaECola" class="btn-copy-compact">
            <mat-icon>content_copy</mat-icon>
            <span>Copiar</span>
          </button>
        </div>
      </div>

      <p class="loading-message">
        {{ loadingMessage }}
      </p>
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      <p class="warning-text">
        Não feche esta página. Você será redirecionado automaticamente
        assim que o pagamento for aprovado.
      </p>
    </div>
  </div>

  <!-- Formulário de Checkout -->
  <div *ngIf="checkoutState === 'form'">
    <div class="checkout-container">
      <div class="checkout-content">
        
        <!-- Bloco 0: Cadastro de Guest User (se não logado) -->
        <div *ngIf="isGuestUser" class="guest-user-block card">
          <h2 class="section-title">
            <mat-icon>person_add</mat-icon>
            Seus dados
          </h2>
          <p class="section-description">Preencha seus dados para finalizar o pedido</p>
          
          <form [formGroup]="guestUserForm">
            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Nome completo</mat-label>
                <input matInput formControlName="name" placeholder="Seu nome completo">
                <mat-icon matPrefix>person</mat-icon>
                <mat-error *ngIf="guestUserForm.get('name')?.errors?.['required']">
                  Nome é obrigatório
                </mat-error>
                <mat-error *ngIf="guestUserForm.get('name')?.errors?.['minlength']">
                  Nome deve ter no mínimo 3 caracteres
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>E-mail</mat-label>
                <input matInput formControlName="email" type="email" placeholder="seu@email.com">
                <mat-icon matPrefix>email</mat-icon>
                <mat-error *ngIf="guestUserForm.get('email')?.errors?.['required']">
                  E-mail é obrigatório
                </mat-error>
                <mat-error *ngIf="guestUserForm.get('email')?.errors?.['email']">
                  E-mail inválido
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>CPF ou CNPJ</mat-label>
                <input 
                  matInput 
                  formControlName="document_number" 
                  placeholder="000.000.000-00 ou 00.000.000/0000-00"
                  (input)="formatDocument($event)"
                  maxlength="18">
                <mat-icon matPrefix>badge</mat-icon>
                <mat-error *ngIf="guestUserForm.get('document_number')?.errors?.['required']">
                  CPF/CNPJ é obrigatório
                </mat-error>
                <mat-error *ngIf="guestUserForm.get('document_number')?.errors?.['invalidDocument']">
                  Documento inválido
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Celular</mat-label>
                <input 
                  matInput 
                  formControlName="phone" 
                  placeholder="(00) 00000-0000" 
                  (input)="formatPhoneGuest($event)">
                <mat-icon matPrefix>phone</mat-icon>
                <mat-error *ngIf="guestUserForm.get('phone')?.errors?.['required']">
                  Celular é obrigatório
                </mat-error>
                <mat-error *ngIf="guestUserForm.get('phone')?.errors?.['invalidPhone']">
                  {{ guestUserForm.get('phone')?.errors?.['invalidPhone']?.message || 'Celular inválido' }}
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Senha (opcional)</mat-label>
                <input 
                  matInput 
                  type="password"
                  formControlName="password" 
                  placeholder="Deixe em branco para gerar senha automática">
                <mat-icon matPrefix>lock</mat-icon>
                <mat-hint>Se não preencher, uma senha será gerada e enviada por e-mail</mat-hint>
              </mat-form-field>
            </div>
          </form>
        </div>

        <!-- Bloco 1: Endereço -->
        <div class="address-block card">
          <div class="address-header">
            <div class="address-info">
              <mat-icon>place</mat-icon>
              <div class="address-text">
                <h3>Endereço de entrega</h3>
                <div *ngIf="useSavedAddress && selectedAddressId">
                  <ng-container *ngFor="let addr of addresses">
                    <p *ngIf="addr.id === selectedAddressId" class="address-display">
                      <strong>{{ addr.street }}, {{ addr.number }}</strong>
                      <span *ngIf="addr.complement"> - {{ addr.complement }}</span><br>
                      {{ addr.neighborhood }}, {{ addr.city }}/{{ addr.state }}<br>
                      CEP: {{ addr.zipcode }}
                    </p>
                  </ng-container>
                </div>
                <div *ngIf="!useSavedAddress && deliveryForm.get('address')?.value" class="address-display">
                  <strong>{{ deliveryForm.get('address')?.value }}, {{ deliveryForm.get('number')?.value }}</strong>
                  <span *ngIf="deliveryForm.get('complement')?.value"> - {{ deliveryForm.get('complement')?.value }}</span><br>
                  {{ deliveryForm.get('neighborhood')?.value }}, {{ deliveryForm.get('city')?.value }}/{{ deliveryForm.get('state')?.value }}<br>
                  CEP: {{ deliveryForm.get('zipcode')?.value }}
                </div>
                <p *ngIf="!useSavedAddress && !deliveryForm.get('address')?.value" class="address-empty">
                  Endereço não informado
                </p>
              </div>
            </div>
            <button mat-button class="alter-address-btn" (click)="showAddressForm = !showAddressForm">
              <mat-icon>edit</mat-icon>
              Alterar
            </button>
          </div>

          <!-- Formulário de Endereço (Expansível) -->
          <div class="address-form-expandable" *ngIf="showAddressForm">
            <form [formGroup]="deliveryForm" class="delivery-form">
              <!-- Seleção de Endereços Salvos -->
              <div *ngIf="addresses.length > 0" class="address-selection">
                <div class="address-options">
                  <mat-radio-group [value]="useSavedAddress" (change)="onAddressOptionChange($event)">
                    <mat-radio-button [value]="true" *ngIf="addresses.length > 0" class="address-option">
                      <div class="option-content">
                        <mat-icon>bookmark</mat-icon>
                        <span>Usar endereço salvo</span>
                      </div>
                    </mat-radio-button>
                    <mat-radio-button [value]="false" class="address-option">
                      <div class="option-content">
                        <mat-icon>add_location</mat-icon>
                        <span>Novo endereço</span>
                      </div>
                    </mat-radio-button>
                  </mat-radio-group>
                </div>

                <!-- Lista de Endereços Salvos -->
                <div *ngIf="useSavedAddress" class="saved-addresses">
                  <div *ngFor="let address of addresses" 
                       class="address-card-small" 
                       [class.selected]="selectedAddressId === address.id"
                       (click)="selectAddress(address.id)">
                    <div class="address-header-small">
                      <h4>{{address.name || 'Endereço'}}</h4>
                      <mat-chip *ngIf="address.is_default" color="primary" class="default-chip">
                        <mat-icon>star</mat-icon>
                        Padrão
                      </mat-chip>
                    </div>
                    <div class="address-details-small">
                      <p><strong>{{address.street}}, {{address.number}}</strong></p>
                      <p *ngIf="address.complement">{{address.complement}}</p>
                      <p>{{address.neighborhood}}, {{address.city}}/{{address.state}}</p>
                      <p>CEP: {{address.zipcode}}</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Formulário de Novo Endereço -->
              <div class="address-form" *ngIf="!useSavedAddress">
                <!-- Linha 1: CEP + Botão Buscar -->
                <div class="form-row cep-row">
                  <mat-form-field class="cep-input">
                    <mat-label>CEP</mat-label>
                    <input matInput formControlName="zipcode" placeholder="00000-000" (input)="formatZipcode($event); clearError()" (blur)="calculateFreteFromCep()">
                    <mat-error *ngIf="deliveryForm.get('zipcode')?.errors?.['required']">CEP é obrigatório</mat-error>
                    <mat-error *ngIf="deliveryForm.get('zipcode')?.errors?.['pattern']">CEP inválido</mat-error>
                  </mat-form-field>
                  <button mat-raised-button color="primary" (click)="searchCep()" 
                          [disabled]="!deliveryForm.get('zipcode')?.value || deliveryForm.get('zipcode')?.errors || loading"
                          class="cep-button">
                    <mat-icon>search</mat-icon>
                    <span *ngIf="!loading">Buscar</span>
                    <span *ngIf="loading">Buscando...</span>
                  </button>
                </div>

                <!-- Linha 2: Endereço + Número -->
                <div class="form-row address-number-row">
                  <mat-form-field class="address-field">
                    <mat-label>Endereço</mat-label>
                    <input matInput formControlName="address" placeholder="Rua, Avenida, etc">
                    <mat-error *ngIf="deliveryForm.get('address')?.errors?.['required']">Endereço é obrigatório</mat-error>
                  </mat-form-field>
                  <mat-form-field class="number-field">
                    <mat-label>Número</mat-label>
                    <input matInput formControlName="number" placeholder="123">
                    <mat-error *ngIf="deliveryForm.get('number')?.errors?.['required']">Número é obrigatório</mat-error>
                  </mat-form-field>
                </div>

                <!-- Linha 3: Bairro + Complemento -->
                <div class="form-row neighborhood-complement-row">
                  <mat-form-field class="neighborhood-field">
                    <mat-label>Bairro</mat-label>
                    <input matInput formControlName="neighborhood" placeholder="Seu bairro" (input)="onNeighborhoodChange()">
                    <mat-error *ngIf="deliveryForm.get('neighborhood')?.errors?.['required']">Bairro é obrigatório</mat-error>
                  </mat-form-field>
                  <mat-form-field class="complement-field">
                    <mat-label>Complemento</mat-label>
                    <input matInput formControlName="complement" placeholder="Apto, Bloco, etc">
                  </mat-form-field>
                </div>

                <!-- Linha 4: Cidade + Estado/UF -->
                <div class="form-row city-state-row">
                  <mat-form-field class="city-field">
                    <mat-label>Cidade</mat-label>
                    <input matInput formControlName="city" placeholder="Sua cidade">
                    <mat-error *ngIf="deliveryForm.get('city')?.errors?.['required']">Cidade é obrigatória</mat-error>
                  </mat-form-field>
                  <mat-form-field class="state-field">
                    <mat-label>Estado</mat-label>
                    <input matInput formControlName="state" placeholder="UF" maxlength="2">
                    <mat-error *ngIf="deliveryForm.get('state')?.errors?.['required']">Estado é obrigatório</mat-error>
                  </mat-form-field>
                </div>

                <!-- Instruções para entrega -->
                <div class="form-row">
                  <mat-form-field class="full-width">
                    <mat-label>Instruções para entrega</mat-label>
                    <textarea matInput formControlName="instructions" placeholder="Instruções especiais para entrega"></textarea>
                  </mat-form-field>
                </div>
              </div>

              <!-- Seção de Frete -->
              <div class="delivery-fee-section" *ngIf="selectedNeighborhood && isDeliveryAreaValid">
                <div class="fee-card">
                  <div class="fee-header">
                    <mat-icon>local_shipping</mat-icon>
                    <h4>Frete para {{ selectedNeighborhood }}</h4>
                  </div>
                  <div class="fee-details">
                    <div class="fee-amount">
                      <span class="fee-label">Valor do frete:</span>
                      <span class="fee-value">R$ {{ (deliveryFee * 1) | number:'1.2-2' }}</span>
                    </div>
                    <div class="delivery-time" *ngIf="estimatedTime">
                      <mat-icon>schedule</mat-icon>
                      <span>{{ estimatedTime }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Alerta de Área de Entrega -->
              <div *ngIf="!isDeliveryAreaValid && !loadingDeliveryZones && (deliveryForm.get('zipcode')?.value || selectedAddressId)" class="delivery-area-warning">
                <mat-icon color="warn">warning</mat-icon>
                <span>Fora da área de entrega</span>
              </div>
            </form>
          </div>
        </div>

        <!-- Bloco 2: Sugestões de Produtos (Upsell) -->
        <div class="suggestions-block">
          <h2 class="section-title">
            <mat-icon>shopping_bag</mat-icon>
            Não esqueceu de nada?
          </h2>
          <app-product-suggestions [cartItems$]="cartItems$"></app-product-suggestions>
        </div>

        <!-- Bloco 3: Forma de Pagamento -->
        <div class="payment-block card">
          <h2 class="section-title">
            <mat-icon>payment</mat-icon>
            Forma de pagamento
          </h2>

          <form [formGroup]="paymentForm">
            <div class="payment-cards">
              <button type="button" 
                      class="payment-card-selectable"
                      [class.selected]="paymentForm.get('method')?.value === 'pix'"
                      (click)="paymentForm.patchValue({ method: 'pix' })">
                <div class="payment-icon-large">
                  <mat-icon>qr_code</mat-icon>
                </div>
                <div class="payment-text">
                  <h3>PIX</h3>
                  <p>Pagamento online via QR Code</p>
                </div>
              </button>

              <button type="button" 
                      class="payment-card-selectable"
                      [class.selected]="paymentForm.get('method')?.value === 'cash'"
                      (click)="paymentForm.patchValue({ method: 'cash' })">
                <div class="payment-icon-large">
                  <mat-icon>money</mat-icon>
                </div>
                <div class="payment-text">
                  <h3>Dinheiro</h3>
                  <p>Pagamento na entrega</p>
                </div>
              </button>

              <button type="button" 
                      class="payment-card-selectable"
                      [class.selected]="paymentForm.get('method')?.value === 'card'"
                      (click)="paymentForm.patchValue({ method: 'card' })">
                <div class="payment-icon-large">
                  <mat-icon>credit_card</mat-icon>
                </div>
                <div class="payment-text">
                  <h3>Cartão</h3>
                  <p>Cartão na entrega</p>
                </div>
              </button>
            </div>

            <!-- Campo de Troco (Dinheiro) -->
            <div class="change-field-expandable" *ngIf="paymentForm.get('method')?.value === 'cash'">
              <mat-form-field class="full-width">
                <mat-label>Valor a ser pago</mat-label>
                <input 
                  id="received-amount-input" 
                  matInput 
                  formControlName="received_amount" 
                  type="text" 
                  placeholder="0,00 ou 0.00"
                  (blur)="onReceivedAmountBlur($event)">
                <mat-hint>Informe o valor que você vai usar para pagar (aceita vírgula ou ponto)</mat-hint>
              </mat-form-field>
              <div class="change-info" *ngIf="getSanitizedReceivedAmount() > ((cartTotal$ | async) || 0) + deliveryFee">
                <mat-icon>info</mat-icon>
                <span>Troco: R$ {{ (getSanitizedReceivedAmount() - ((cartTotal$ | async) || 0) - deliveryFee) | number:'1.2-2' }}</span>
              </div>
            </div>

            <!-- Mensagem de Erro -->
            <div *ngIf="error" class="error-message">
              <mat-icon>error</mat-icon>
              <span>{{ error }}</span>
            </div>
          </form>
        </div>

        <!-- Resumo do Pedido (Acordeão Discreto) -->
        <div class="order-summary-block card">
          <button type="button" class="summary-toggle" (click)="showOrderSummary = !showOrderSummary">
            <div class="summary-header-toggle">
              <div>
                <h3>Resumo do pedido</h3>
                <p>{{ (cartItems$ | async)?.length || 0 }} itens</p>
              </div>
              <mat-icon [class.rotated]="showOrderSummary">expand_more</mat-icon>
            </div>
          </button>

          <div class="summary-content" *ngIf="showOrderSummary">
            <ng-container *ngIf="cartItems$ | async as items">
              <!-- Estado Vazio -->
              <div *ngIf="items.length === 0" class="empty-cart-summary">
                <mat-icon>shopping_cart</mat-icon>
                <p>Seu carrinho está vazio</p>
              </div>

              <!-- Lista de Itens -->
              <div *ngIf="items.length > 0" class="cart-items-summary">
                <div *ngFor="let item of items" class="cart-item-summary">
                <div class="item-image-small">
                  <img [src]="getImageUrl(item)" [alt]="getItemName(item)">
                </div>
                <div class="item-details-summary">
                  <h4 class="item-name-summary">{{ getItemName(item) }}</h4>
                  <div class="item-info-summary">
                    <span class="item-price-summary">R$ {{ (item.price * 1) | number:'1.2-2' }}</span>
                  </div>
                </div>
                <div class="item-controls-summary">
                  <!-- Controles de Quantidade -->
                  <div class="quantity-controls-summary">
                    <button mat-icon-button 
                            class="qty-btn-summary minus" 
                            (click)="decrement(item)" 
                            aria-label="Diminuir quantidade">
                      <mat-icon>remove</mat-icon>
                    </button>
                    <span class="quantity-summary">{{ item.quantity }}</span>
                    <button mat-icon-button 
                            class="qty-btn-summary plus" 
                            (click)="increment(item)"
                            [disabled]="!canIncreaseQuantity(item)"
                            aria-label="Aumentar quantidade">
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                  <!-- Botão Remover -->
                  <button mat-icon-button 
                          class="remove-button-summary" 
                          (click)="removeItem(item)" 
                          aria-label="Remover item">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
                <div class="item-total-summary">
                  R$ {{ ((item.price * 1) * (item.quantity * 1)) | number:'1.2-2' }}
                </div>
              </div>
              </div>
            </ng-container>

            <div class="order-totals-summary">
              <div class="total-row-summary">
                <span>Subtotal</span>
                <span>R$ {{ ((cartTotal$ | async) || 0) * 1 | number:'1.2-2' }}</span>
              </div>
              <div class="total-row-summary">
                <span>Taxa de entrega</span>
                <span *ngIf="deliveryFee > 0">R$ {{ (deliveryFee * 1) | number:'1.2-2' }}</span>
                <span *ngIf="deliveryFee === 0" class="free-delivery">Grátis</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Campos Condicionais: CPF e Telefone do Usuário -->
        <div *ngIf="needsDocumentNumber || needsPhone" class="user-data-block card">
          <h2 class="section-title">
            <mat-icon>person</mat-icon>
            Complete seus dados
          </h2>
          <p class="section-description">Precisamos dessas informações para processar seu pedido.</p>
          
          <form [formGroup]="userDataForm">
            <!-- Campo CPF -->
            <div *ngIf="needsDocumentNumber" class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>CPF ou CNPJ</mat-label>
                <input 
                  matInput 
                  id="user-document_number"
                  formControlName="document_number" 
                  placeholder="000.000.000-00 ou 00.000.000/0000-00"
                  (input)="formatDocument($event)"
                  maxlength="18"
                  class="user-data-field">
                <mat-icon matPrefix>badge</mat-icon>
                <mat-error *ngIf="userDataForm.get('document_number')?.errors?.['required']">
                  CPF/CNPJ é obrigatório
                </mat-error>
                <mat-error *ngIf="userDataForm.get('document_number')?.errors?.['invalidDocument']">
                  {{ userDataForm.get('document_number')?.errors?.['invalidDocument']?.message || 'Documento inválido' }}
                </mat-error>
                <mat-error *ngIf="userDataForm.get('document_number')?.errors?.['invalidCpf']">
                  {{ userDataForm.get('document_number')?.errors?.['invalidCpf']?.message || 'CPF inválido' }}
                </mat-error>
                <mat-error *ngIf="userDataForm.get('document_number')?.errors?.['invalidCnpj']">
                  {{ userDataForm.get('document_number')?.errors?.['invalidCnpj']?.message || 'CNPJ inválido' }}
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Campo Telefone -->
            <div *ngIf="needsPhone" class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Telefone</mat-label>
                <input 
                  matInput 
                  id="user-phone"
                  formControlName="phone" 
                  placeholder="(00) 00000-0000" 
                  (input)="formatPhoneUserData($event)"
                  class="user-data-field">
                <mat-icon matPrefix>phone</mat-icon>
                <mat-error *ngIf="userDataForm.get('phone')?.errors?.['required']">
                  Telefone é obrigatório
                </mat-error>
                <mat-error *ngIf="userDataForm.get('phone')?.errors?.['invalidPhone']">
                  {{ userDataForm.get('phone')?.errors?.['invalidPhone']?.message || 'Telefone inválido' }}
                </mat-error>
              </mat-form-field>
            </div>
          </form>
        </div>

        <!-- Espaço para o footer fixo -->
        <div class="bottom-spacer"></div>
      </div>
    </div>

    <!-- Sticky Footer -->
    <div class="sticky-footer">
      <div class="footer-content">
        <div class="footer-total">
          <span class="total-label">Total</span>
          <span class="total-value">R$ {{ ((cartTotal$ | async) || 0) * 1 + (deliveryFee * 1) | number:'1.2-2' }}</span>
        </div>
        <button mat-raised-button 
                color="primary" 
                class="finalize-button"
                (click)="onSubmit()" 
                [disabled]="loading || isProcessingPayment || !isDeliveryAreaValid || !(isStoreOpen$ | async)">
          <mat-spinner *ngIf="loading || isProcessingPayment" diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
          <mat-icon *ngIf="!(loading || isProcessingPayment)">shopping_cart</mat-icon>
          <span *ngIf="!(loading || isProcessingPayment)">Fazer Pedido</span>
          <span *ngIf="loading || isProcessingPayment">Processando...</span>
        </button>
      </div>
    </div>
  </div>
</div>
