<div class="dashboard-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Carregando dashboard...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && summary" class="dashboard-content">
    <!-- Header com botão de atualizar -->
    <div class="dashboard-header">
      <h1>Dashboard</h1>
      <button mat-icon-button (click)="refresh()" [disabled]="loading">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>

    <!-- Cards de Resumo -->
    <div class="summary-cards">
      <!-- Vendas -->
      <mat-card class="summary-card modern-card">
        <mat-card-content>
          <div class="card-header">
            <div class="card-icon sales-icon">
              <mat-icon>payments</mat-icon>
            </div>
            <div class="card-title">
              <h2>Vendas</h2>
              <p class="card-subtitle">Receita total</p>
            </div>
          </div>
          <div class="card-content">
            <div class="main-stat">
              <span class="main-value">{{summary ? formatCurrency(summary.sales.month) : 'R$ 0,00'}}</span>
              <span class="main-label">Este Mês</span>
            </div>
            <div class="secondary-stats">
              <div class="stat">
                <span class="label">Hoje</span>
                <span class="value">{{summary ? formatCurrency(summary.sales.today) : 'R$ 0,00'}}</span>
              </div>
              <div class="stat">
                <span class="label">Ticket Médio</span>
                <span class="value">{{summary ? formatCurrency(summary.sales.average_ticket) : 'R$ 0,00'}}</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Pedidos -->
      <mat-card class="summary-card modern-card">
        <mat-card-content>
          <div class="card-header">
            <div class="card-icon orders-icon">
              <mat-icon>shopping_cart</mat-icon>
            </div>
            <div class="card-title">
              <h2>Pedidos</h2>
              <p class="card-subtitle">Status dos pedidos</p>
            </div>
          </div>
          <div class="card-content">
            <div class="chart-container">
              <canvas baseChart
                [data]="ordersPieChartData"
                [options]="ordersPieChartOptions"
                type="pie"
                class="pie-chart">
              </canvas>
            </div>
            <div class="chart-stats">
              <div class="stat">
                <span class="label">Pendentes</span>
                <span class="value" [style.color]="getStatusColor(summary ? summary.orders.pending : 0, 5)">
                  {{summary ? summary.orders.pending : 0}}
                </span>
              </div>
              <div class="stat">
                <span class="label">Concluídos</span>
                <span class="value">{{summary ? summary.orders.completed : 0}}</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Estoque -->
      <mat-card class="summary-card modern-card">
        <mat-card-content>
          <div class="card-header">
            <div class="card-icon stock-icon">
              <mat-icon>inventory</mat-icon>
            </div>
            <div class="card-title">
              <h2>Estoque</h2>
              <p class="card-subtitle">Status do estoque</p>
            </div>
          </div>
          <div class="card-content">
            <div class="chart-container">
              <canvas baseChart
                [data]="stockPieChartData"
                [options]="stockPieChartOptions"
                type="pie"
                class="pie-chart">
              </canvas>
            </div>
            <div class="chart-stats">
              <div class="stat">
                <span class="label">Total Produtos</span>
                <span class="value">{{summary ? summary.stock.total_products : 0}}</span>
              </div>
              <div class="stat">
                <span class="label">Estoque Baixo</span>
                <span class="value" [style.color]="getStatusColor(summary ? summary.stock.low_stock_count : 0, 10)">
                  {{summary ? summary.stock.low_stock_count : 0}}
                </span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Usuários -->
      <mat-card class="summary-card modern-card">
        <mat-card-content>
          <div class="card-header">
            <div class="card-icon users-icon">
              <mat-icon>people</mat-icon>
            </div>
            <div class="card-title">
              <h2>Usuários</h2>
              <p class="card-subtitle">Distribuição de usuários</p>
            </div>
          </div>
          <div class="card-content">
            <div class="chart-container">
              <canvas baseChart
                [data]="usersPieChartData"
                [options]="usersPieChartOptions"
                type="pie"
                class="pie-chart">
              </canvas>
            </div>
            <div class="chart-stats">
              <div class="stat">
                <span class="label">Total</span>
                <span class="value">{{summary ? summary.users.total : 0}}</span>
              </div>
              <div class="stat">
                <span class="label">Novos (Mês)</span>
                <span class="value">{{summary ? summary.users.new_this_month : 0}}</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Gráfico de Vendas -->
    <mat-card class="chart-card modern-card">
      <mat-card-header>
        <mat-card-title>Vendas dos Últimos 30 Dias</mat-card-title>
        <mat-card-subtitle>Evolução das vendas</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container-large">
          <canvas baseChart
            [data]="salesChartData"
            [options]="salesChartOptions"
            type="line"
            class="line-chart">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Gráfico de Clientes -->
    <mat-card class="chart-card modern-card">
      <mat-card-header>
        <mat-card-title>Clientes (Últimos 30 dias)</mat-card-title>
        <mat-card-subtitle>Novos vs. Recorrentes</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container-large">
          <canvas id="customerPizzaChart"></canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Top Products e Customers -->
    <div class="dashboard-tables">
      <!-- Top Products -->
      <mat-card class="table-card">
        <mat-card-header>
          <mat-card-title>Produtos Mais Vendidos</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="topProducts">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Produto</th>
              <td mat-cell *matCellDef="let product">{{product.name}}</td>
            </ng-container>

            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Qtd. Vendida</th>
              <td mat-cell *matCellDef="let product">{{product.quantity_sold}}</td>
            </ng-container>

            <ng-container matColumnDef="revenue">
              <th mat-header-cell *matHeaderCellDef>Receita</th>
              <td mat-cell *matCellDef="let product">{{formatCurrency(product.total_revenue)}}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['name', 'quantity', 'revenue']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['name', 'quantity', 'revenue'];"></tr>
          </table>
        </mat-card-content>
      </mat-card>

      <!-- Top Customers -->
      <mat-card class="table-card">
        <mat-card-header>
          <mat-card-title>Melhores Clientes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="topCustomers">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Cliente</th>
              <td mat-cell *matCellDef="let customer">{{customer.name}}</td>
            </ng-container>

            <ng-container matColumnDef="orders">
              <th mat-header-cell *matHeaderCellDef>Pedidos</th>
              <td mat-cell *matCellDef="let customer">{{customer.orders_count}}</td>
            </ng-container>

            <ng-container matColumnDef="spent">
              <th mat-header-cell *matHeaderCellDef>Total Gasto</th>
              <td mat-cell *matCellDef="let customer">{{formatCurrency(customer.total_spent)}}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['name', 'orders', 'spent']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['name', 'orders', 'spent'];"></tr>
          </table>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
