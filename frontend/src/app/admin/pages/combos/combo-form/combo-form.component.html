<div class="combo-form-container">
  <div class="form-header">
    <h1>{{ isEdit ? 'Editar Bundle' : 'Novo Bundle' }}</h1>
    <p>{{ isEdit ? 'Atualize as informações do bundle' : 'Preencha as informações para criar um novo bundle' }}</p>
  </div>

  <form [formGroup]="bundleForm" (ngSubmit)="onSubmit()" class="combo-form">
    <!-- Informações Básicas -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>Informações Básicas</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nome do Bundle</mat-label>
            <input matInput formControlName="name" placeholder="Ex: Kit Gin Tônica">
            <mat-error *ngIf="bundleForm.get('name')?.hasError('required')">
              Nome é obrigatório
            </mat-error>
            <mat-error *ngIf="bundleForm.get('name')?.hasError('maxlength')">
              Nome deve ter no máximo 255 caracteres
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descrição</mat-label>
            <textarea matInput formControlName="description" rows="3" placeholder="Descreva o bundle..."></textarea>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Tipo de Bundle</mat-label>
            <mat-select formControlName="bundle_type">
              <mat-option value="combo">Combo</mat-option>
              <mat-option value="copao">Copão</mat-option>
              <mat-option value="custom">Personalizado</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Tipo de Precificação</mat-label>
            <mat-select formControlName="pricing_type">
              <mat-option value="fixed">Preço Fixo</mat-option>
              <mat-option value="calculated">Preço Calculado</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="barcode-field">
            <mat-label>Código de Barras</mat-label>
            <input matInput formControlName="barcode" placeholder="Opcional">
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Grupos de Escolha (Accordion estilo iFood/Shopify) -->
    <mat-card class="form-section groups-section-card">
      <mat-card-header>
        <mat-card-title>Grupos de Escolha</mat-card-title>
        <mat-card-subtitle>Configure os grupos e os produtos de cada um</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div formArrayName="groups">
          <mat-accordion class="groups-accordion" multi>
            <mat-expansion-panel *ngFor="let group of groupsFormArray.controls; let groupIndex = index" 
                                [formGroupName]="groupIndex" 
                                class="group-panel"
                                [class.group-required]="group.get('min_selections')?.value > 0"
                                [class.group-error-highlight]="group.invalid && (group.touched || isSubmitted)">
              <mat-expansion-panel-header class="group-panel-header">
                <mat-panel-title class="group-panel-title">
                  <span class="group-name-display">{{ group.get('name')?.value || 'Seleção ' + (groupIndex + 1) }}</span>
                  <span class="group-badge obrigatorio" *ngIf="group.get('min_selections')?.value > 0">Obrigatório</span>
                </mat-panel-title>
                <mat-panel-description class="group-panel-description">
                  <button type="button" mat-icon-button color="warn" 
                          (click)="removeGroup(groupIndex); $event.stopPropagation()" 
                          matTooltip="Remover grupo"
                          class="group-delete-btn">
                    <mat-icon>delete</mat-icon>
                  </button>
                </mat-panel-description>
              </mat-expansion-panel-header>

              <div class="group-panel-body">
                <div class="group-fields">
                  <mat-form-field appearance="outline" class="group-name-field">
                    <mat-label>Nome do grupo</mat-label>
                    <input matInput formControlName="name" placeholder="Ex: Escolha seu Gin">
                    <mat-error *ngIf="group.get('name')?.hasError('required')">Nome é obrigatório</mat-error>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="group-desc-field">
                    <mat-label>Descrição (opcional)</mat-label>
                    <textarea matInput formControlName="description" rows="2" placeholder="Ex: Escolha uma opção"></textarea>
                  </mat-form-field>
                </div>

                <div class="group-minmax-row">
                  <mat-form-field appearance="outline" class="minmax-field">
                    <mat-label>Mínimo de escolhas</mat-label>
                    <input matInput type="number" formControlName="min_selections" min="0">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="minmax-field">
                    <mat-label>Máximo de escolhas</mat-label>
                    <input matInput type="number" formControlName="max_selections" min="1">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="selection-type-field">
                    <mat-label>Tipo</mat-label>
                    <mat-select formControlName="selection_type">
                      <mat-option value="single">Única</mat-option>
                      <mat-option value="multiple">Múltipla</mat-option>
                    </mat-select>
                  </mat-form-field>
                  <div class="group-required-toggle">
                    <mat-checkbox formControlName="is_required">Obrigatório</mat-checkbox>
                  </div>
                </div>

                <div class="options-section">
                  <div class="options-label">Produtos do grupo</div>
                  <div formArrayName="options" class="options-list">
                    <div *ngFor="let option of getGroupOptionsFormArray(groupIndex).controls; let optionIndex = index" 
                         [formGroupName]="optionIndex" class="option-row">
                      <div class="option-main">
                        <mat-form-field appearance="outline" class="option-product-field">
                          <mat-label>Produto</mat-label>
                          <input matInput 
                                 [formControl]="getOptionProductControl(groupIndex, optionIndex)"
                                 [matAutocomplete]="autoOption"
                                 placeholder="Buscar produto...">
                          <mat-icon matSuffix>search</mat-icon>
                          <mat-autocomplete #autoOption="matAutocomplete" 
                                            [displayWith]="displayProductName"
                                            (optionSelected)="getGroupOptionsFormArray(groupIndex).at(optionIndex).patchValue({ product_id: $event.option.value.id, product: $event.option.value })">
                            <mat-option *ngFor="let product of getFilteredProducts$(groupIndex, optionIndex) | async" [value]="product">
                              {{ product.name }} - {{ formatPrice(product.price) }}
                            </mat-option>
                          </mat-autocomplete>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="option-qty-field">
                          <mat-label>Qtd</mat-label>
                          <input matInput type="number" formControlName="quantity" min="1">
                        </mat-form-field>
                        <button type="button" mat-icon-button color="warn" 
                                (click)="removeOptionFromGroup(groupIndex, optionIndex)" 
                                matTooltip="Remover produto"
                                class="option-delete-btn">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </div>
                      <div class="option-extra">
                        <mat-form-field appearance="outline" class="option-sale-type-field">
                          <mat-label>Venda</mat-label>
                          <mat-select formControlName="sale_type">
                            <mat-option value="garrafa">Garrafa</mat-option>
                            <mat-option value="dose">Dose</mat-option>
                          </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="option-adjust-field">
                          <mat-label>Ajuste (R$)</mat-label>
                          <input matInput type="number" formControlName="price_adjustment" step="0.01" min="0">
                        </mat-form-field>
                      </div>
                    </div>
                  </div>
                  <button type="button" mat-stroked-button (click)="addOptionToGroup(groupIndex)" class="add-option-btn">
                    <mat-icon>add</mat-icon>
                    Adicionar produto
                  </button>
                </div>
                <div class="group-error-message" *ngIf="group.invalid && (group.touched || isSubmitted)">
                  <mat-icon>error</mat-icon>
                  <span *ngIf="getGroupOptionsFormArray(groupIndex).length === 0">
                    Este grupo precisa de pelo menos 1 produto selecionado.
                  </span>
                  <span *ngIf="getGroupOptionsFormArray(groupIndex).length > 0 && group.get('name')?.invalid">
                    Preencha o nome do grupo.
                  </span>
                  <span *ngIf="getGroupOptionsFormArray(groupIndex).length > 0 && group.get('name')?.valid && group.invalid">
                    Verifique os campos obrigatórios deste grupo.
                  </span>
                </div>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </div>

        <button type="button" mat-raised-button color="primary" (click)="addGroup()" class="add-group-button">
          <mat-icon>add</mat-icon>
          Adicionar Grupo
        </button>

        <div class="no-groups-message" *ngIf="groupsFormArray.length === 0">
          <mat-icon>info</mat-icon>
          <p>Nenhum grupo adicionado. Clique em "Adicionar Grupo" para começar.</p>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Preços e Descontos -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>Preços e Descontos</mat-card-title>
        <mat-card-subtitle>Configure os preços e descontos do bundle</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="price-calculation" *ngIf="originalPrice > 0 && bundleForm.get('pricing_type')?.value === 'calculated'">
          <div class="price-info">
            <div class="price-item">
              <span class="price-label">Preço Original (Calculado):</span>
              <span class="price-value">{{ formatPrice(originalPrice) }}</span>
            </div>
            <div class="price-item" *ngIf="bundleForm.get('discount_percentage')?.value > 0">
              <span class="price-label">Desconto:</span>
              <span class="price-value discount">
                {{ bundleForm.get('discount_percentage')?.value }}%
              </span>
            </div>
          </div>
        </div>

        <div class="form-row" *ngIf="bundleForm.get('pricing_type')?.value === 'fixed'">
          <mat-form-field appearance="outline" class="price-field">
            <mat-label>Preço Base</mat-label>
            <input matInput type="number" formControlName="base_price" step="0.01" min="0">
            <span matPrefix>R$&nbsp;</span>
            <mat-error *ngIf="bundleForm.get('base_price')?.hasError('required')">
              Preço base é obrigatório para precificação fixa
            </mat-error>
            <mat-error *ngIf="bundleForm.get('base_price')?.hasError('min')">
              Preço deve ser maior que zero
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="price-field">
            <mat-label>Preço Original</mat-label>
            <input matInput type="number" formControlName="original_price" step="0.01" min="0">
            <span matPrefix>R$&nbsp;</span>
            <mat-hint *ngIf="bundleForm.get('pricing_type')?.value === 'calculated'">
              Calculado automaticamente pela soma das opções selecionadas
            </mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="discount-field">
            <mat-label>Desconto (%)</mat-label>
            <input matInput type="number" formControlName="discount_percentage" step="0.01" min="0" max="100">
            <span matSuffix>%</span>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Imagens -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>Imagens do Bundle</mat-card-title>
        <mat-card-subtitle>Adicione imagens para o bundle (máximo 5 imagens)</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="images-section">
          <!-- Preview das imagens existentes (modo edição) -->
          <div *ngIf="isEdit && existingImages.length > 0" class="existing-images">
            <div *ngFor="let imageUrl of existingImages; let i = index" class="image-preview">
              <img [src]="imageUrl" alt="Imagem do bundle">
              <button type="button" mat-icon-button color="warn" (click)="removeExistingImage(i)"
                matTooltip="Remover imagem">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>

          <!-- Preview das novas imagens selecionadas -->
          <div *ngIf="selectedImages.length > 0" class="selected-images">
            <div *ngFor="let image of selectedImages; let i = index" class="image-preview">
              <img [src]="getImagePreview(i)" alt="Preview">
              <button type="button" mat-icon-button color="warn" (click)="removeImage(i)" matTooltip="Remover imagem">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>

          <!-- Input de upload -->
          <div class="upload-section">
            <input type="file" #fileInput multiple accept="image/*" (change)="onImageSelected($event)"
              style="display: none">
            <button type="button" mat-stroked-button (click)="fileInput.click()"
              [disabled]="selectedImages.length >= 5">
              <mat-icon>add_photo_alternate</mat-icon>
              Adicionar Imagens
            </button>
            <span class="image-count" *ngIf="selectedImages.length > 0">
              {{ selectedImages.length }} / 5 imagens selecionadas
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Configurações -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>Configurações</mat-card-title>
        <mat-card-subtitle>Configure as opções de exibição do combo</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="checkbox-group">
          <mat-checkbox formControlName="is_active">
            Bundle Ativo
          </mat-checkbox>
          <mat-checkbox formControlName="featured">
            Em Destaque
          </mat-checkbox>
          <mat-checkbox formControlName="offers">
            Oferta
          </mat-checkbox>
          <mat-checkbox formControlName="popular">
            Popular
          </mat-checkbox>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Botões de Ação -->
    <div class="form-actions">
      <button type="button" mat-stroked-button (click)="onCancel()" [disabled]="loading">
        Cancelar
      </button>
      <button type="submit" mat-raised-button color="primary"
        [disabled]="loading">
        <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
        <mat-icon *ngIf="!loading">{{ isEdit ? 'save' : 'add' }}</mat-icon>
        {{ isEdit ? 'Atualizar' : 'Criar' }} Bundle
      </button>
    </div>
  </form>
</div>