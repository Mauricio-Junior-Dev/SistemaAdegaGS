import{h as I}from"./chunk-L7YZATBO.js";import{a as w}from"./chunk-JEC3ZXLW.js";import{Zc as C,a as n,b as c,f as g,ga as f,la as u,m as h,w as p}from"./chunk-QUOLBKI4.js";var x=class S{constructor(t,e,o){this.authService=t;this.http=e;this.toastr=o;try{let a=localStorage.getItem("cart");if(a){let{items:i,total:s}=JSON.parse(a);Array.isArray(i)&&this.cartState.next({items:i,total:s||0,isOpen:!1})}}catch(a){console.error("Error loading cart from localStorage:",a),localStorage.removeItem("cart")}this.authService.user$.subscribe(a=>{if(!a){let i=localStorage.getItem("cart");if(i){let{items:s,total:l}=JSON.parse(i);this.cartState.next({items:s,total:l,isOpen:!1})}}})}initialState={items:[],total:0,isOpen:!1};cartState=new h(this.initialState);cartItems$=this.cartState.pipe(p(t=>t.items||[]));isCartOpen$=this.cartState.pipe(p(t=>t.isOpen));itemAdded$=new h(!1);saveCart(){console.log("Saving cart to localStorage");let t=this.cartState.value||this.initialState,e={items:t.items||[],total:t.total||0};console.log("Cart data to save:",e),localStorage.setItem("cart",JSON.stringify(e))}calculateTotal(t){return t.reduce((e,o)=>e+o.price*o.quantity,0)}addItem(t,e=1){console.log("CartService.addItem:",{product:t,quantity:e});let o=this.cartState.value||this.initialState;console.log("Current state:",o);let a=o.items||[],i=a.find(d=>d.id===t.id);if(console.log("Existing item:",i),(i?i.quantity:0)+e>t.current_stock){this.toastr.warning(`Estoque m\xE1ximo atingido para este produto. Restam apenas ${t.current_stock} unidades.`,"Estoque Insuficiente");return}let m;if(i)console.log("Updating existing item"),m=a.map(d=>d.id===t.id?c(n({},d),{quantity:d.quantity+e}):d);else{console.log("Adding new item");let d={id:t.id,product:t,quantity:e,price:t.price};m=[...a,d]}console.log("Updated items:",m);let r=this.calculateTotal(m);console.log("New total:",r);let v=c(n({},o),{items:m,total:r,isOpen:o.isOpen});console.log("New state:",v),this.cartState.next(v),this.saveCart(),this.itemAdded$.next(!0),setTimeout(()=>this.itemAdded$.next(!1),300),this.authService.isLoggedIn()}addComboToCart(t,e=1){console.log("CartService.addComboToCart:",{combo:t,quantity:e});let o=this.cartState.value||this.initialState,a=o.items||[],i=a.find(r=>r.id===t.id&&r.isCombo),s;if(i)console.log("Updating existing combo item"),s=a.map(r=>r.id===t.id&&r.isCombo?c(n({},r),{quantity:r.quantity+e}):r);else{console.log("Adding new combo item");let r={id:t.id,combo:t,quantity:e,price:t.price,isCombo:!0};s=[...a,r]}console.log("Updated items:",s);let l=this.calculateTotal(s);console.log("New total:",l);let m=c(n({},o),{items:s,total:l,isOpen:!0});this.cartState.next(m),this.saveCart(),this.itemAdded$.next(!0),setTimeout(()=>this.itemAdded$.next(!1),300),this.authService.isLoggedIn()}removeItem(t){let e=this.cartState.value||this.initialState,a=(e.items||[]).filter(l=>l.id!==t),i=this.calculateTotal(a),s=c(n({},e),{items:a,total:i});this.cartState.next(s),this.saveCart(),this.authService.isLoggedIn()}updateQuantity(t,e){if(e<=0){this.removeItem(t);return}let o=this.cartState.value||this.initialState,a=o.items||[],i=a.find(r=>r.id===t);if(i&&i.product&&!i.isCombo&&e>i.product.current_stock){this.toastr.warning(`Estoque m\xE1ximo atingido para este produto. Restam apenas ${i.product.current_stock} unidades.`,"Estoque Insuficiente");return}let s=a.map(r=>r.id===t?c(n({},r),{quantity:e}):r),l=this.calculateTotal(s),m=c(n({},o),{items:s,total:l});this.cartState.next(m),this.saveCart(),this.authService.isLoggedIn()}clearCart(){this.cartState.next({items:[],total:0,isOpen:!1}),localStorage.removeItem("cart")}openCart(){this.cartState.next(c(n({},this.cartState.value),{isOpen:!0}))}closeCart(){this.cartState.next(c(n({},this.cartState.value),{isOpen:!1}))}toggleCart(){this.cartState.next(c(n({},this.cartState.value),{isOpen:!this.cartState.value.isOpen}))}getTotal(){return this.cartState.value?.total||0}getCartState(){return this.cartState.value||this.initialState}finishOrder(t){return g(this,null,function*(){try{if(!this.authService.isLoggedIn())throw new Error("Usu\xE1rio n\xE3o autenticado");let e=c(n({},t),{items:this.cartState.value.items,total:this.cartState.value.total}),o=yield this.http.post("/api/orders",e).toPromise();return this.clearCart(),o}catch(e){throw console.error("Erro ao finalizar pedido:",e),e}})}static \u0275fac=function(e){return new(e||S)(u(w),u(C),u(I))};static \u0275prov=f({token:S,factory:S.\u0275fac,providedIn:"root"})};export{x as a};
