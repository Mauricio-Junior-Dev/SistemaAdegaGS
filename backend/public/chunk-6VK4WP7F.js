import{$ as l,C as b,F as h,Zc as f,aa as y,da as n,dd as v,ga as _,la as O,m as g,w as r}from"./chunk-QUOLBKI4.js";var C=class o{constructor(e){this.http=e}apiUrl=`${v.apiUrl}/orders`;ordersSubject=new g([]);autoRefreshInterval=15e3;autoRefreshSubscription;orders$=this.ordersSubject.asObservable();startAutoRefresh(){this.autoRefreshSubscription||(this.autoRefreshSubscription=h(this.autoRefreshInterval).pipe(l(0),y(()=>this.fetchOrders({status:"processing"}))).subscribe({error:e=>{console.error("Erro no auto refresh de pedidos:",e)}}))}stopAutoRefresh(){this.autoRefreshSubscription&&(this.autoRefreshSubscription.unsubscribe(),this.autoRefreshSubscription=void 0)}fetchOrders(e){let t={};return e?.status&&(t.status=e.status),e?.page&&(t.page=e.page),e?.per_page&&(t.per_page=e.per_page),e?.search&&(t.search=e.search),e?.sort_by&&(t.sort_by=e.sort_by),e?.sort_order&&(t.sort_order=e.sort_order),this.http.get(this.apiUrl,{params:t}).pipe(n(s=>{!e?.status&&!e?.search&&this.ordersSubject.next(s.data)}))}fetchOrdersLegacy(e){return this.fetchOrders(e).pipe(r(t=>t.data))}updateOrderStatus(e,t){return this.http.patch(`${this.apiUrl}/${e}/status`,{status:t}).pipe(n(s=>{let d=this.ordersSubject.value.map(a=>a.id===e?s:a);this.ordersSubject.next(d)}))}printOrderAutomatically(e){return this.http.post(`${this.apiUrl}/${e}/print`,{})}completeOrder(e){return this.updateOrderStatus(e,"completed")}createOrder(e){return this.http.post(`${this.apiUrl}`,e).pipe(n(()=>{this.fetchOrders().subscribe()}))}createManualOrder(e){return this.http.post(`${this.apiUrl}/manual`,e).pipe(n(()=>{this.fetchOrders().subscribe()}))}getOrdersSummary(){let e=this.fetchOrders({page:1,per_page:1,status:"pending"}),t=this.fetchOrders({page:1,per_page:1,status:"processing"}),s=this.fetchOrders({page:1,per_page:1,status:"delivering"}),u=this.fetchOrders({page:1,per_page:1,status:"completed"}),d=this.fetchOrders({page:1,per_page:100,status:"completed"});return b({pending:e,processing:t,delivering:s,completed:u,todayCompleted:d}).pipe(r(({pending:a,processing:S,delivering:R,completed:P,todayCompleted:x})=>{let m=new Date;m.setHours(0,0,0,0);let c=x.data.filter(p=>{let i=new Date(p.created_at);return i.setHours(0,0,0,0),i.getTime()===m.getTime()}),$=c.reduce((p,i)=>p+i.total,0),q=c.length;return{total_amount:$,total_orders:q,pending:a.total,processing:S.total,delivering:R.total,completed:P.total}}))}generateOrderPrint(e){return this.http.get(`${this.apiUrl}/${e}`).pipe(r(t=>this.generatePrintHTML(t)))}generatePrintHTML(e){return`
      <div style="font-family: monospace; width: 300px; padding: 10px;">
        <h2>ADEGA GS - Pedido #${e.order_number}</h2>
        <p>Data: ${new Date(e.created_at).toLocaleString()}</p>
        <p>Cliente: ${e.user.name}</p>
        <hr>
        ${e.items.map(t=>`
          <div>
            ${t.quantity}x ${t.is_combo&&t.combo?t.combo.name:t.product?.name||"Produto n\xE3o encontrado"}
            <span style="float: right">R$ ${(t.price*t.quantity).toFixed(2)}</span>
          </div>
        `).join("")}
        <hr>
        <p style="text-align: right; font-weight: bold;">
          Total: R$ ${e.total.toFixed(2)}
        </p>
        <p>Forma de pagamento: ${this.getPaymentMethodFromOrder(e)}</p>
        <p>Status: ${this.getStatusLabel(e.status)}</p>
      </div>
    `}getStatusLabel(e){return{pending:"Pendente",processing:"Em Processamento",preparing:"Preparando",delivering:"Em Entrega",completed:"Conclu\xEDdo",cancelled:"Cancelado"}[e]}getPaymentMethodFromOrder(e){if(e.payment_method)return this.formatPaymentMethod(e.payment_method);if(e.payment){if(Array.isArray(e.payment)&&e.payment.length>0)return this.formatPaymentMethod(e.payment[0].payment_method);if(!Array.isArray(e.payment))return this.formatPaymentMethod(e.payment.payment_method)}return"N\xE3o informado"}formatPaymentMethod(e){return{dinheiro:"Dinheiro",cartao:"Cart\xE3o",pix:"PIX",credito:"Cart\xE3o de Cr\xE9dito",debito:"Cart\xE3o de D\xE9bito"}[e]||e}searchCustomers(e){return this.http.get(`${this.apiUrl.replace("/orders","")}/customers/search`,{params:{search:e}}).pipe(r(t=>t.customers))}createQuickCustomer(e){return this.http.post(`${this.apiUrl.replace("/orders","")}/customers/quick`,e).pipe(r(t=>t.customer))}static \u0275fac=function(t){return new(t||o)(O(f))};static \u0275prov=_({token:o,factory:o.\u0275fac,providedIn:"root"})};export{C as a};
